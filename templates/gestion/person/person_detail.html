{% extends "gestion/base.html" %}
{% block content %}
<div class="row p-4">
    <div class="col-sm-12 mt-3">
        <div class="card">
            <div class="card-header">
                Coordonnées
                <a href= "{% url 'update_person' person.id %}" class="close">
                    <i class="fas fa-pen"></i>
                </a>
                </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-sm-6">
                        <strong> Prénom </strong> : {{person.first_name}} <br>
                    </div>
                    <div class="col-sm-6">
                        <strong> Nom </strong> : {{person.last_name}} <br>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-sm-12">
                        <strong> Statut </strong> :
                        <span id="status-badge" class="badge {% if person.inactif %}badge-danger{% else %}badge-success{% endif %}">
                            {% if person.inactif %}Inactif{% else %}Actif{% endif %}
                        </span>
                        <button
                            id="toggle-status-btn"
                            class="btn btn-sm btn-outline-primary ml-3"
                            data-url="{% url 'toggle_person_status' person.id %}"
                        >
                            Activation/Désactivation
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-6">
                        <strong> Email </strong> : {{person.email}} <br>
                    </div>
                    <div class="col-sm-6">
                        <strong> Téléphone </strong> : {{person.telephone}} <br>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <strong> Adresse </strong> : {{person.get_complete_address}} <br>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <strong> Commentaire </strong> : {{person.commentaire}} <br>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-sm-6">
                        <strong> Date de première consultation </strong> :
                        {{ person.get_first_consultation_date|date:"d/m/Y"|default:" - " }} <br>
                    </div>
                    <div class="col-sm-6">
                        <strong> Date de dernière consultation </strong> :
                        {{ person.get_last_consultation_date|date:"d/m/Y"|default:" - " }} <br>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <strong> Nombre de consultations </strong> :
                        {{ person.get_total_consultations }} <br>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <strong> Professionnel du monde animalier </strong> :
                        {{ person.professionnel_monde_animalier|default:"Non spécifié" }} <br>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="row p-4">
    <div class="col-sm-12 mt-3">
        <div class="card">
            <div class="card-header">
                Liste des animaux
            </div>
            <div class="table-responsive-sm p-4">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th scope="col">Nom</th>
                            <th scope="col">Type</th>
                            <th scope="col">Sexe</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for animal in person.animal_set.all %}
                        <tr class="table-info">
                            <td><a href = "{% url 'detail_animal' animal.id %}"> {{animal.name}}</a></td>
                            <td>{{animal.get_type_display}}</td>
                            <td>{{animal.get_sex_display}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="text-right">
    <a href= "{% url 'create_animal' %}?proprietaire={{person.id}}" class="btn btn-info">Ajouter animal</a>
</div>

<script>
    document.getElementById("toggle-status-btn").addEventListener("click", function (e) {
        e.preventDefault();
        const url = this.getAttribute("data-url");
        if (confirm("Êtes-vous sûr de vouloir basculer le statut ?")) {
            fetch(url, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json",
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Erreur lors de la requête.");
                }
                return response.json();
            })
            .then(data => {
                const badge = document.getElementById("status-badge");
                if (data.inactif) {
                    badge.textContent = "Inactif";
                    badge.className = "badge badge-danger";
                } else {
                    badge.textContent = "Actif";
                    badge.className = "badge badge-success";
                }
            })
            .catch(error => {
                console.error("Erreur :", error);
                alert("Une erreur est survenue.");
            });
        }
    });
</script>


{% endblock %}